import streamlit as st
import requests
import pandas as pd
from datetime import datetime

# --- í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(
    page_title="ë„¤ì´ë²„ ë¶€ë™ì‚° ì‹¤ì‹œê°„ ë¶„ì„ê¸°",
    page_icon="ğŸ ",
    layout="wide"
)

# --- ìŠ¤íƒ€ì¼ë§ (CSS) ---
st.markdown("""
    <style>
    .big-font { font-size:20px !important; font-weight: bold; }
    .stDataFrame { width: 100%; }
    </style>
    """, unsafe_allow_html=True)

# --- 1. ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜ (Backend Logic) ---
@st.cache_data(ttl=300) # 5ë¶„ë§ˆë‹¤ ìºì‹œ ì´ˆê¸°í™” (ì‹¤ì‹œê°„ì„± ìœ ì§€í•˜ë©´ì„œ ì„œë²„ ë¶€í•˜ ë°©ì§€)
def fetch_naver_land_data(complex_list):
    url_base = "https://new.land.naver.com/api/articles/complex/{}"
    
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",
        "Referer": "https://new.land.naver.com/"
    }
    
    all_data = []
    
    for complex_info in complex_list:
        try:
            # ê¸°ë³¸ íŒŒë¼ë¯¸í„° (ë§¤ë§¤, ì „ì„¸, ì›”ì„¸ ì „ì²´ ì¡°íšŒ)
            params = {
                'realEstateType': 'APT',
                'tradeType': 'A1:B1:B2', # ë§¤ë§¤:A1, ì „ì„¸:B1, ì›”ì„¸:B2
                'tag': ' :::',
                'rentPriceMin': '0',
                'rentPriceMax': '900000000',
                'priceMin': '0',
                'priceMax': '900000000',
                'areaMin': '0',
                'areaMax': '900000000',
                'oldBuildYears': '',
                'recentlyBuildYears': '',
                'minHouseHoldCount': '',
                'maxHouseHoldCount': '',
                'showArticle': 'false',
                'sameAddressGroup': 'false',
                'minMaintenanceCost': '',
                'maxMaintenanceCost': '',
                'priceType': 'RETAIL',
                'directions': '',
                'page': '1',
                'complexNo': complex_info['id'],
            }
            
            res = requests.get(url_base.format(complex_info['id']), headers=headers, params=params)
            data = res.json()
            articles = data.get('articleList', [])
            
            for article in articles:
                # ê°€ê²© íŒŒì‹± (ë„¤ì´ë²„ëŠ” '15ì–µ 5,000' í˜•íƒœë¡œ ì¤Œ)
                price_str = article.get('dealOrWarrantPrc', '0')
                rent_str = article.get('rentPrc', '0')
                
                def parse_price(p_str):
                    if not p_str: return 0
                    p_str = p_str.replace(',', '')
                    total = 0
                    if 'ì–µ' in p_str:
                        parts = p_str.split('ì–µ')
                        uk = int(parts[0]) * 10000
                        man = int(parts[1]) if len(parts) > 1 and parts[1] else 0
                        total = uk + man
                    else:
                        total = int(p_str)
                    return total

                price_val = parse_price(price_str)
                rent_val = int(rent_str.replace(',', '')) if rent_str else 0
                
                # ë„¤ì´ë²„ ì œê³µ ì •ë³´
                item = {
                    'ë‹¨ì§€ëª…': complex_info['name'],
                    'ë§¤ë¬¼ëª…': article.get('articleName'),
                    'ë™': article.get('buildingName'),
                    'ê±°ë˜ìœ í˜•': article.get('tradeTypeName'),
                    'ê°€ê²©(í™”ë©´ìš©)': f"{price_str}{f' / {rent_str}' if rent_val > 0 else ''}",
                    'ë³´ì¦ê¸ˆ/ë§¤ë§¤ê°€(ë§Œì›)': price_val,
                    'ì›”ì„¸(ë§Œì›)': rent_val,
                    'ì¸µ': article.get('floorInfo'),
                    'ë©´ì ': article.get('areaName'),
                    'ì„¤ëª…': article.get('articleFeatureDesc'),
                    'ë„¤ì´ë²„í™•ì¸': article.get('confirmedDate'),
                }
                all_data.append(item)
                
        except Exception as e:
            st.error(f"{complex_info['name']} ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            
    return pd.DataFrame(all_data)

# --- 2. ì›¹ í™”ë©´ êµ¬ì„± (Frontend Logic) ---
st.title("ğŸ  ë„¤ì´ë²„ ë¶€ë™ì‚° ì‹¤ì‹œê°„ ìŠ¤ìºë„ˆ")
st.markdown("ê´€ì‹¬ ë‹¨ì§€ì˜ **ìµœì €ê°€ ë§¤ë¬¼**ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì™€ **ì „ì„¸ í™˜ì‚°ê°€**ë¡œ ë¹„êµí•©ë‹ˆë‹¤.")

# ì‚¬ì´ë“œë°”: ì„¤ì • ì˜ì—­
with st.sidebar:
    st.header("ğŸ› ï¸ ì„¤ì •")
    
    st.info("ğŸ’¡ **ë‹¨ì§€ ë²ˆí˜¸ ì°¾ëŠ” ë²•**\n\në„¤ì´ë²„ ë¶€ë™ì‚°ì—ì„œ ë‹¨ì§€ë¥¼ í´ë¦­í–ˆì„ ë•Œ URLì˜ ìˆ«ìì…ë‹ˆë‹¤.\nì˜ˆ: `new.land.naver.com/complexes/19772` -> **19772**")
    
    # ë‹¨ì§€ ì¶”ê°€ ì…ë ¥
    user_complex_input = st.text_area(
        "ë‹¨ì§€ ëª©ë¡ (ì´ë¦„,ë²ˆí˜¸ í˜•ì‹ìœ¼ë¡œ ì¤„ë°”ê¿ˆ)",
        value="ì ì‹¤ì—˜ìŠ¤,19772\në¦¬ì„¼ì¸ ,19773\níŠ¸ë¦¬ì§€ì›€,19774",
        height=100
    )
    
    # ì…ë ¥ê°’ íŒŒì‹±
    target_complexes = []
    for line in user_complex_input.split('\n'):
        if ',' in line:
            name, cid = line.split(',')
            target_complexes.append({'name': name.strip(), 'id': cid.strip()})
            
    st.markdown("---")
    st.subheader("ğŸ’° í™˜ì‚° ê¸°ì¤€")
    conversion_rate = st.number_input("1ì–µ ë‹¹ ì›”ì„¸ (ë§Œì›)", value=40, step=1, help="ì˜ˆ: 40ë§Œì› = 1ì–µìœ¼ë¡œ ê³„ì‚°")

    if st.button("ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨", type="primary"):
        st.cache_data.clear() # ìºì‹œ ì‚­ì œí•˜ì—¬ ê°•ì œ ì¬ë¡œë”©
        st.rerun()

# ë©”ì¸ ë¡œì§
if not target_complexes:
    st.warning("ë‹¨ì§€ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
else:
    with st.spinner('ë„¤ì´ë²„ ë¶€ë™ì‚°ì—ì„œ ì‹¤ì‹œê°„ ë§¤ë¬¼ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...'):
        df = fetch_naver_land_data(target_complexes)

    if not df.empty:
        # --- 3. ë°ì´í„° ê°€ê³µ (í™˜ì‚°ê°€ ê³„ì‚°) ---
        # í™˜ì‚°ì „ì„¸ê°€ = ë³´ì¦ê¸ˆ + (ì›”ì„¸ / ì „í™˜ìœ¨ * 1ì–µ)
        df['í™˜ì‚°ì „ì„¸(ë§Œì›)'] = df.apply(
            lambda x: x['ë³´ì¦ê¸ˆ/ë§¤ë§¤ê°€(ë§Œì›)'] + (x['ì›”ì„¸(ë§Œì›)'] / conversion_rate * 10000) if x['ì›”ì„¸(ë§Œì›)'] > 0 else x['ë³´ì¦ê¸ˆ/ë§¤ë§¤ê°€(ë§Œì›)'], 
            axis=1
        )
        df['í™˜ì‚°ì „ì„¸(ë§Œì›)'] = df['í™˜ì‚°ì „ì„¸(ë§Œì›)'].astype(int)

        # ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ… í•¨ìˆ˜
        def format_money(val):
            uk = val // 10000
            man = val % 10000
            if uk > 0 and man > 0: return f"{uk}ì–µ {man}ë§Œ"
            if uk > 0: return f"{uk}ì–µ"
            return f"{man}ë§Œ"

        df['í™˜ì‚°ê°€(ë³´ê¸°)'] = df['í™˜ì‚°ì „ì„¸(ë§Œì›)'].apply(format_money)

        # --- 4. í•„í„°ë§ UI ---
        col1, col2, col3 = st.columns(3)
        with col1:
            selected_type = st.multiselect("ê±°ë˜ ìœ í˜•", df['ê±°ë˜ìœ í˜•'].unique(), default=df['ê±°ë˜ìœ í˜•'].unique())
        with col2:
            selected_complex = st.multiselect("ë‹¨ì§€ ì„ íƒ", df['ë‹¨ì§€ëª…'].unique(), default=df['ë‹¨ì§€ëª…'].unique())
        with col3:
            sort_option = st.radio("ì •ë ¬ ê¸°ì¤€", ["ë‚®ì€ ê°€ê²©ìˆœ", "ë†’ì€ ê°€ê²©ìˆœ"], horizontal=True)

        # í•„í„° ì ìš©
        mask = (df['ê±°ë˜ìœ í˜•'].isin(selected_type)) & (df['ë‹¨ì§€ëª…'].isin(selected_complex))
        filtered_df = df[mask].copy()

        # ì •ë ¬ ì ìš©
        ascending = True if sort_option == "ë‚®ì€ ê°€ê²©ìˆœ" else False
        filtered_df = filtered_df.sort_values(by='í™˜ì‚°ì „ì„¸(ë§Œì›)', ascending=ascending)

        # --- 5. ê²°ê³¼ ì¶œë ¥ ---
        st.subheader(f"ğŸ“Š ë¶„ì„ ê²°ê³¼ ({len(filtered_df)}ê±´)")
        
        # ì¤‘ìš” ì»¬ëŸ¼ë§Œ ì„ íƒí•´ì„œ ë³´ì—¬ì£¼ê¸°
        display_cols = ['ë‹¨ì§€ëª…', 'ê±°ë˜ìœ í˜•', 'ê°€ê²©(í™”ë©´ìš©)', 'í™˜ì‚°ê°€(ë³´ê¸°)', 'ë™', 'ì¸µ', 'ë©´ì ', 'ì„¤ëª…']
        
        # ë°ì´í„°í”„ë ˆì„ ìŠ¤íƒ€ì¼ë§ (í™˜ì‚°ê°€ê°€ ê°€ì¥ ë‚®ì€ ë§¤ë¬¼ ê°•ì¡°)
        st.dataframe(
            filtered_df[display_cols],
            hide_index=True,
            column_config={
                "í™˜ì‚°ê°€(ë³´ê¸°)": st.column_config.TextColumn(
                    "í™˜ì‚°ê°€ (ê¸°ì¤€ ì ìš©)",
                    help=f"ì›”ì„¸ {conversion_rate}ë§Œì› = 1ì–µ ê¸°ì¤€ í™˜ì‚°",
                ),
                "ê°€ê²©(í™”ë©´ìš©)": "ì›ë˜ ê°€ê²©"
            },
            use_container_width=True
        )

    else:
        st.error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¨ì§€ ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")